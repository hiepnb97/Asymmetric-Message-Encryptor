<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang Người Nhận - Giải Mã Tin Nhắn Bảo Mật | EZSE.net</title>
  <meta name="description" content="Trang giải mã tin nhắn bảo mật. Tạo khóa RSA-2048, nhận và giải mã tin nhắn được mã hóa. Bảo mật tuyệt đối với mã hóa bất đối xứng.">
  <meta name="keywords" content="giải mã tin nhắn, RSA-2048, khóa bảo mật, tin nhắn mã hóa, EZSE">
  <meta name="author" content="EZSE.net">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Trang Người Nhận - Giải Mã Tin Nhắn Bảo Mật | EZSE.net">
  <meta property="og:description" content="Tạo khóa RSA-2048 và giải mã tin nhắn bảo mật. Bảo mật tuyệt đối với mã hóa bất đối xứng.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ezse.net/Asymmetric-Message-Encryptor/receiver.html">
  <meta property="og:image" content="https://ezse.net/Asymmetric-Message-Encryptor/og-image.png">
  <link rel="canonical" href="https://ezse.net/Asymmetric-Message-Encryptor/receiver.html">
  <link rel="icon" type="image/png" href="https://ezse.net/images/easy.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-size: 14px;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    pre {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
      border: 1px solid #e9ecef;
      margin: 0;
    }
    .btn {
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
    }
    .btn-copy {
      padding: 4px 8px;
      font-size: 12px;
    }
    .form-control {
      font-size: 14px;
      border-radius: 8px;
      padding: 8px 12px;
    }
    .form-label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .time-note {
      font-size: 12px;
      color: #6c757d;
      padding: 6px 10px;
      background: #e9ecef;
      border-radius: 6px;
      margin-top: 8px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container py-4" style="max-width: 680px;">
    <div class="text-center mb-4">
      <h4 class="mb-1">
        <i class="bi bi-key text-success"></i>
        Trang Người Nhận
      </h4>
      <p class="text-muted small">Tạo khóa và giải mã tin nhắn</p>
    </div>

    <div class="card mb-3">
      <div class="card-body p-3">
        <button onclick="generateKeys()" class="btn btn-success w-100">
          <i class="bi bi-key-fill me-1"></i>
          Tạo cặp khóa mới
        </button>

        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">
              <i class="bi bi-globe me-1"></i>
              Public Key (chia sẻ)
            </label>
            <button class="btn btn-outline-secondary btn-copy" onclick="copyText('publicKey', event)">
              <i class="bi bi-clipboard me-1"></i>
              Copy
            </button>
          </div>
          <pre id="publicKey" class="mb-0"></pre>
        </div>

        <div class="mt-3">
          <label class="form-label">
            <i class="bi bi-lock-fill me-1"></i>
            Private Key (giữ bí mật)
          </label>
          <textarea id="privateKey" class="form-control" rows="3" placeholder="Dán Private Key của bạn vào đây..."></textarea>
          <div class="mt-2">
            <button class="btn btn-outline-secondary btn-sm py-1 px-2" style="font-size: 12px;" onclick="importPrivateKey()">
              <i class="bi bi-key me-1"></i>
              Sửa Private Key
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body p-3">
        <div class="mb-3">
          <label class="form-label">
            <i class="bi bi-envelope me-1"></i>
            Bản mã cần giải
          </label>
          <textarea id="ciphertext" class="form-control" rows="3" placeholder="Dán bản mã vào đây..."></textarea>
        </div>

        <button onclick="decryptMessage()" class="btn btn-primary w-100">
          <i class="bi bi-unlock-fill me-1"></i>
          Giải mã tin nhắn
        </button>

        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">
              <i class="bi bi-chat-text me-1"></i>
              Kết quả giải mã
            </label>
            <button class="btn btn-outline-secondary btn-copy" onclick="copyText('decrypted', event)">
              <i class="bi bi-clipboard me-1"></i>
              Copy
            </button>
          </div>
          <div class="position-relative">
            <pre id="decrypted"></pre>
            <div id="decrypted-copied" class="position-absolute top-50 start-50 translate-middle bg-dark text-white px-3 py-2 rounded" style="display: none; z-index: 1000;">
              <i class="bi bi-check2"></i> Đã copy
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="max-width: 680px;">
    <div class="text-center mt-4 mb-2">
      <a href="index.html" class="text-muted" style="text-decoration: none; font-size: 14px;">
        <i class="bi bi-info-circle me-1"></i>
        Xem hướng dẫn sử dụng
      </a>
    </div>
  </div>

  <script>
    let privateKey;

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    function saveKeys(publicKeyB64, privateKeyB64) {
      localStorage.setItem('savedPublicKey', publicKeyB64);
      localStorage.setItem('savedPrivateKey', privateKeyB64);
      localStorage.setItem('keyGeneratedTime', new Date().toLocaleString());
    }

    async function loadSavedKeys() {
      const savedPublicKey = localStorage.getItem('savedPublicKey');
      const savedPrivateKey = localStorage.getItem('savedPrivateKey');
      const keyGeneratedTime = localStorage.getItem('keyGeneratedTime');

      if (savedPublicKey && savedPrivateKey) {
        document.getElementById("publicKey").textContent = savedPublicKey;
        document.getElementById("privateKey").textContent = savedPrivateKey;

        const privateKeyBuffer = base64ToArrayBuffer(savedPrivateKey);
        privateKey = await crypto.subtle.importKey(
          "pkcs8",
          privateKeyBuffer,
          {
            name: "RSA-OAEP",
            hash: "SHA-256"
          },
          true,
          ["decrypt"]
        );

        const timeNote = document.createElement('div');
        timeNote.className = 'time-note';
        timeNote.innerHTML = `<i class="bi bi-clock me-1"></i>${keyGeneratedTime}`;
        document.getElementById("publicKey").parentNode.insertBefore(timeNote, document.getElementById("publicKey").nextSibling);
        
        return true;
      }

      // Nếu không có khóa, tự động tạo cặp khóa mới
      document.getElementById("publicKey").textContent = "Đang tạo khóa mới...";
      document.getElementById("privateKey").textContent = "Đang tạo khóa mới...";
      await generateKeys(true);
      return true;
    }

    async function generateKeys(skipConfirm = false) {
      if (!skipConfirm && localStorage.getItem('savedPublicKey')) {
        const confirmNew = confirm('⚠️ Bạn đã có một cặp khóa được lưu. Tạo cặp khóa mới sẽ xóa cặp khóa cũ.\n\nBạn có chắc chắn muốn tạo cặp khóa mới không?');
        if (!confirmNew) return;
      }

      const keyPair = await window.crypto.subtle.generateKey(
        {
          name: "RSA-OAEP",
          modulusLength: 2048,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: "SHA-256",
        },
        true,
        ["encrypt", "decrypt"]
      );

      const exportedPublic = await crypto.subtle.exportKey("spki", keyPair.publicKey);
      const exportedPrivate = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);

      const publicKeyB64 = arrayBufferToBase64(exportedPublic);
      const privateKeyB64 = arrayBufferToBase64(exportedPrivate);

      document.getElementById("publicKey").textContent = publicKeyB64;
      document.getElementById("privateKey").textContent = privateKeyB64;

      privateKey = keyPair.privateKey;
      saveKeys(publicKeyB64, privateKeyB64);

      // Xóa time note cũ nếu có
      const oldTimeNote = document.querySelector('.time-note');
      if (oldTimeNote) oldTimeNote.remove();
      
      // Tải lại để hiển thị time note mới
      loadSavedKeys();
    }

    async function decryptMessage() {
      try {
        const cipherBase64 = document.getElementById("ciphertext").value.trim();
        if (!cipherBase64) {
          document.getElementById("decrypted").textContent = "⚠️ Vui lòng nhập bản mã để giải mã";
          return;
        }

        if (!privateKey) {
          document.getElementById("decrypted").textContent = "⚠️ Vui lòng tạo hoặc tải khóa trước khi giải mã";
          return;
        }

        const encrypted = base64ToArrayBuffer(cipherBase64);
        const decrypted = await crypto.subtle.decrypt(
          { name: "RSA-OAEP" },
          privateKey,
          encrypted
        );

        const decoder = new TextDecoder();
        document.getElementById("decrypted").textContent = decoder.decode(decrypted);
      } catch (error) {
        document.getElementById("decrypted").textContent = "❌ Lỗi giải mã: Bản mã không hợp lệ hoặc đã bị hỏng";
      }
    }

    function copyText(elementId, event) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(() => {
        // Handle button text change if clicked from a button
        if (event) {
          const btn = event.target.closest('.btn-copy');
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2 me-1"></i>Đã copy';
            setTimeout(() => {
              btn.innerHTML = originalText;
            }, 1000);
          }
        }
        
        // Show popup notification
        const popup = document.getElementById(elementId + '-copied');
        if (popup) {
          popup.style.display = 'block';
          setTimeout(() => {
            popup.style.display = 'none';
          }, 1000);
        }
      });
    }

    async function importPrivateKey() {
      try {
        const privateKeyB64 = document.getElementById("privateKey").value.trim();
        if (!privateKeyB64) {
          alert("⚠️ Vui lòng nhập Private Key");
          return;
        }

        const privateKeyBuffer = base64ToArrayBuffer(privateKeyB64);
        privateKey = await crypto.subtle.importKey(
          "pkcs8",
          privateKeyBuffer,
          {
            name: "RSA-OAEP",
            hash: "SHA-256"
          },
          true,
          ["decrypt"]
        );

        // Save the imported private key
        const publicKeyB64 = document.getElementById("publicKey").textContent;
        if (publicKeyB64) {
          saveKeys(publicKeyB64, privateKeyB64);
        }

        alert("✅ Đã sửa Private Key thành công!");
      } catch (error) {
        alert("❌ Lỗi: Private Key không hợp lệ");
        console.error(error);
      }
    }

    window.addEventListener('load', loadSavedKeys);
  </script>
</body>
</html>